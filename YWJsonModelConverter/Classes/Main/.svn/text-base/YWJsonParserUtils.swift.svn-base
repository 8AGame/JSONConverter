//
//  YWJsonParserUtils.swift
//  Test
//
//  Created by 姚巍 on 2018/2/3.
//  Copyright © 2018年 姚巍. All rights reserved.
//

import Foundation

class YWJsonParserUtils {
    
    static let shared: YWJsonParserUtils = {
        let manager = YWJsonParserUtils()
        return manager
    }()
    
    var allSubClassStr = ""
    
    var prefixStr = ""
    
    var superClassStr: String = ""
    
    var transStructModelType: YWTransStructModel = YWTransStructModel(transform: .Swift, structure: .struct)
    
    func handleObjEngine(from obj: Any, transModel: YWTransStructModel, prefix: String, rootClassName: String, superClassName: String) -> String{
        allSubClassStr = ""
        prefixStr = prefix
        superClassStr = superClassName
        transStructModelType = transModel
        
        let key = handlePropertyName(propertyKey: rootClassName)
        
        switch obj {
        case let dic as Dictionary<String, Any>:
            _ = handleDictionary(from: dic, key: key, isArr: false)
        case let arr as Array<Any>:
            _ =  handleArray(from: arr, key: key)
        default:
            assert(true, "对象类型不识别")
        }
        
        return allSubClassStr
    }
    
    private func handleNumber(from num: NSNumber, key: String, isArr: Bool) ->String{
        var numProStr = ""
        if num.stringValue.contains(".") {
            numProStr = YWPropertyStrUtils.getCGFloatPropertyStr(transModel: transStructModelType, key: key, isArr: isArr)
        }else{
            numProStr = YWPropertyStrUtils.getIntPropertyStr(transModel: transStructModelType, key: key, isArr: isArr)
        }
        
        return numProStr
    }
    
    private func handleString(from str: String, key: String, isArr: Bool) -> String{
        let strProStr = YWPropertyStrUtils.getStringPropertyStr(transModel: transStructModelType, key: key, isArr: isArr)
        return strProStr
    }
    
    private func handleDictionary(from dic: [String: Any], key: String, isArr: Bool) -> String{
        var currentClassPropertyStr = ""
        var swiftJsonInitStr = ""
        
        dic.forEach { (tuple) in
            let key = handlePropertyName(propertyKey: tuple.key)
            
            switch tuple.value {
            case let num as NSNumber:
                currentClassPropertyStr += handleNumber(from: num, key: key, isArr: false)
            case let str as String:
                currentClassPropertyStr += handleString(from: str, key: key, isArr: false)
            case let dic as Dictionary<String, Any>:
                currentClassPropertyStr += handleDictionary(from: dic, key: key, isArr: false)
            case let arr as Array<Any>:
                currentClassPropertyStr +=  handleArray(from: arr, key: key)
            default:
                assert(true, "对象类型不识别")
            }
            
        }
        
        let subClassName = handleClassName(Key: key)
        let subClassStr = YWPropertyStrUtils.getClassStr(transModel: transStructModelType, className: subClassName, propertyStr: currentClassPropertyStr, superClassName: superClassStr)
        allSubClassStr += subClassStr
        
        currentClassPropertyStr = YWPropertyStrUtils.getObjectPropertyStr(transModel: transStructModelType, key: key, className: subClassName, isArr: isArr)
        
        return currentClassPropertyStr
    }
    
    private func handleArray(from arr: [Any], key: String) ->String{
        if let obj = arr.first {
            switch obj {
            case let num as NSNumber:
                return handleNumber(from: num, key: key, isArr: true)
            case let str as String:
                return handleString(from: str, key: key, isArr: true)
            case let dic as Dictionary<String, Any>:
                return handleDictionary(from: dic, key: key, isArr: true)
            default:
                assert(true, "数组对象类型不识别")
                return ""
            }
        }
        return ""
    }
    
}



extension YWJsonParserUtils {
    private func handleClassName(Key: String) -> String {
        let Name =  Key as NSString
        if Name.length > 0 {
            let first = Name.substring(to: 1)
            let other = Name.substring(from: 1)
            return String(format: "%@%@%@", prefixStr, first.uppercased(), other)
        }
        
        return Name as String
    }
    
    
    private func handlePropertyName(propertyKey: String) -> String {
        let propertyName = propertyKey as NSString
        if  propertyName.length > 0 {
            let first = propertyName.substring(to: 1)
            let other = propertyName.substring(from: 1)
            return String(format: "%@%@", first.lowercased(), other)
        }
        
        return propertyName as String
    }
    
}


